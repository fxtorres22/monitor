<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Raspberry Pi Temperature</title>

<style>
  :root {
    --bg:#0f172a;           /* dark navy background  */
    --card:#1e293b;         /* slightly lighter panel */
    --ink:#f9fafb;          /* main text */
    --muted:#94a3b8;        /* secondary text */
    --ring:#334155;         /* borders */
    --ok:#22c55e;
    --hot:#f87171;
  }
  html,body{margin:0;padding:0;height:100%;background:var(--bg);color:var(--ink);
            font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;}
  .card{max-width:980px;margin:2rem auto;padding:1rem 1.25rem;background:var(--card);
        border:1px solid var(--ring);border-radius:14px;box-shadow:0 4px 14px rgba(0,0,0,.3);}
  .row{display:flex;gap:24px;flex-wrap:wrap;align-items:baseline;}
  .stat{font-size:2.4rem;font-weight:700;}
  .muted{color:var(--muted);font-size:.95rem;}
  #cur.stat.hot{color:var(--hot);}#cur.stat.ok{color:var(--ok);}
  canvas{width:100%;max-width:940px;height:380px;}
  .controls{display:flex;gap:16px;align-items:center;margin:8px 0 0;}
  label{user-select:none;}
  .small{font-size:.9rem;color:var(--muted);}
</style>
</head>
<body>
<div class="card">
  <div class="row">
    <div><div class="muted">Host</div><div id="host" class="stat">—</div></div>
    <div><div class="muted">Current Temp (°C)</div><div id="cur" class="stat">—</div></div>
    <div><div class="muted">Updated (<span id="tz-label">Local</span>)</div>
         <div id="upd" class="stat" style="font-size:1.25rem;">—</div></div>
  </div>

  <div class="controls">
    <label><input type="checkbox" id="tzToggle"> Show times in UTC</label>
    <span class="small">Auto-refreshes every 60 s</span>
  </div>

  <hr/>
  <canvas id="chart"></canvas>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3"></script>
<script>
const BLOB_URL = "https://storagetemperaturedata.blob.core.windows.net/telemetry/temps.json";
const HOT_THRESHOLD = 70;
let chart;
let useLocalTZ = true; // default → local time

function fmtUTC(d){return d.toISOString().replace('T',' ').slice(0,19)+'Z';}
function fmtLocal(d){return d.toLocaleString([], {year:'numeric',month:'2-digit',day:'2-digit',
                                                  hour:'2-digit',minute:'2-digit',second:'2-digit'});}
async function fetchJsonNoCache(url){
  const bust='_ts='+Date.now();const sep=url.includes('?')?'&':'?';
  const r=await fetch(url+sep+bust,{cache:'no-store'});
  if(!r.ok)throw new Error('Fetch failed');return await r.json();
}
const thresholdFillPlugin={
  id:'thresholdFill',
  beforeDraw(chart){const yS=chart.scales.y, area=chart.chartArea;if(!yS)return;
    const y=yS.getPixelForValue(HOT_THRESHOLD), ctx=chart.ctx;
    ctx.save();ctx.globalAlpha=.15;ctx.fillStyle='#ef4444';
    ctx.fillRect(area.left,area.top,area.right-area.left,Math.max(0,y-area.top));ctx.restore();
    ctx.save();ctx.strokeStyle='#ef4444';ctx.setLineDash([4,3]);
    ctx.beginPath();ctx.moveTo(area.left,y);ctx.lineTo(area.right,y);ctx.stroke();ctx.restore();}
};
function buildDataset(data){return data.map(d=>({x:new Date(d.ts),y:+d.temp_c}));}
function tooltipTitle(ctx){const d=new Date(ctx[0].parsed.x);
  return useLocalTZ?fmtLocal(d):fmtUTC(d);}
function tickFormatter(value){const d=new Date(value);
  return useLocalTZ?d.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}):
                    d.toISOString().substring(11,16)+' UTC';}
function render(j){
  const host=j.host??'raspberrypi', data=Array.isArray(j.data)?j.data:[];
  document.getElementById('host').textContent=host;
  const cur=data.length?+data.at(-1).temp_c:NaN;
  const curEl=document.getElementById('cur');
  curEl.textContent=isFinite(cur)?cur.toFixed(1):'—';
  curEl.className='stat '+(isFinite(cur)?(cur>=HOT_THRESHOLD?'hot stat':'ok stat'):'stat');
  const updated=data.length?new Date(data.at(-1).ts):null;
  document.getElementById('tz-label').textContent=useLocalTZ?'Local':'UTC';
  document.getElementById('upd').textContent=updated?(useLocalTZ?fmtLocal(updated):fmtUTC(updated)):'—';

  const points=buildDataset(data);
  if(!chart){
    chart=new Chart(document.getElementById('chart').getContext('2d'),{
      type:'line',
      data:{datasets:[{label:'Temperature (°C)',data:points,tension:.2,pointRadius:0,borderColor:'#60a5fa'}]},
      options:{
        parsing:true,animation:false,normalized:true,
        plugins:{legend:{display:false},tooltip:{mode:'index',intersect:false,callbacks:{title:tooltipTitle}}},
        scales:{
          x:{type:'time',time:{unit:'minute',stepSize:10}, // 10-min grid
             ticks:{color:'#e2e8f0',callback:tickFormatter},grid:{color:'rgba(148,163,184,.2)'}},
          y:{title:{display:true,text:'°C'},ticks:{color:'#e2e8f0'},
             grid:{color:'rgba(148,163,184,.2)'},suggestedMin:20,suggestedMax:80}
        }
      },
      plugins:[thresholdFillPlugin]
    });
  }else{chart.data.datasets[0].data=points;chart.update();}
}
async function loadAndRender(){try{render(await fetchJsonNoCache(BLOB_URL));}
  catch(e){console.error(e);}}
document.getElementById('tzToggle').addEventListener('change',e=>{
  useLocalTZ=!useLocalTZ;loadAndRender();
});
loadAndRender();setInterval(loadAndRender,60_000);
</script>
</body>
</html>
