<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Raspberry Pi Telemetry</title>
<style>
  :root{--bg:#0f172a;--card:#1e293b;--ink:#f9fafb;--muted:#94a3b8;--ring:#334155;
        --ok:#22c55e;--hot:#f87171;--accent:#60a5fa;}
  html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;}
  .wrap{max-width:1080px;margin:24px auto;padding:0 12px;}
  .card{background:var(--card);border:1px solid var(--ring);border-radius:14px;
    box-shadow:0 4px 14px rgba(0,0,0,.3);padding:16px 20px;margin-bottom:16px;}
  .row{display:flex;gap:24px;flex-wrap:wrap;align-items:baseline;}
  .stat{font-size:2.2rem;font-weight:700;}
  .muted{color:var(--muted);font-size:.95rem;}
  #cur.stat.hot{color:var(--hot);}#cur.stat.ok{color:var(--ok);}
  canvas{width:100%;height:360px;}
  .controls{display:flex;gap:16px;align-items:center;margin:8px 0;}
  .badge{border:1px solid var(--ring);border-radius:999px;padding:4px 10px;font-size:.9rem;color:var(--muted);margin-left:8px}
  .bridgeStatus{display:flex;gap:8px;align-items:center;justify-content:space-between;flex-wrap:wrap;}
  .bridgeText{font-weight:800;font-size:1.6rem;letter-spacing:.02em}
  .bridgeText.active{color:#ff6b6b;}      /* vivid red */
  .bridgeText.idle{color:#22c55e;}        /* green */
  hr{border:none;border-top:1px solid var(--ring);margin:12px 0;}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <div class="row">
      <div><div class="muted">Host</div><div id="host" class="stat">—</div></div>
      <div><div class="muted">Temp (°C)</div><div id="cur" class="stat">—</div></div>
      <div><div class="muted">Updated (<span id="tz-label">Local</span>)</div>
           <div id="upd" class="stat" style="font-size:1.1rem;">—</div></div>
    </div>

    <div class="controls">
      <label><input type="checkbox" id="tzToggle"> Show times in UTC</label>
      <span class="muted">Auto-refresh 60 s</span>
      <span id="uplinkBadge" class="badge">uplink: —</span>
      <span id="defaultBadge" class="badge">default: —</span>
    </div>

    <!-- Prominent Bridge Status -->
    <div class="bridgeStatus">
      <div id="bridgeText" class="bridgeText idle">BRIDGE: idle</div>
    </div>
  </div>

  <div class="card"><canvas id="chartTemp"></canvas></div>
  <div class="card"><canvas id="chartCpuRam"></canvas></div>
  <div class="card"><canvas id="chartNet"></canvas></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3"></script>
<script>
const BLOB_URL = "https://storagetemperaturedata.blob.core.windows.net/telemetry/temps.json";
const HOT_THRESHOLD = 70;
let useLocalTZ = true;
let charts = {};

/* ---------------- helpers ---------------- */
function fmtUTC(d){return d.toISOString().replace('T',' ').slice(0,19)+'Z';}
function fmtLocal(d){return d.toLocaleString([], {year:'numeric',month:'2-digit',day:'2-digit',
                                                  hour:'2-digit',minute:'2-digit',second:'2-digit'});}
async function fetchJsonNoCache(url){
  const r=await fetch(url+(url.includes('?')?'&':'?')+'_ts='+Date.now(),{cache:'no-store'});
  if(!r.ok)throw new Error('fetch '+r.status); return await r.json();
}
function toPoints(arr, key){return arr.map(d=>({x:new Date(d.ts), y:Number(d[key])})).filter(p=>Number.isFinite(p.y));}
function mbpsFromBps(bps){return (bps==null)?null:(bps/1_000_000);}

/* --------- time axis with clean 10-min ticks/labels --------- */
function xTimeScale() {
  return {
    type:'time',
    distribution:'linear',
    bounds:'ticks',
    time:{ unit:'minute', stepSize:10, round:'minute' }, // tick/grid every 10 min
    ticks:{
      autoSkip:true,
      autoSkipPadding:8,
      maxRotation:0,
      minRotation:0,
      color:'#e2e8f0',
      callback:(v)=>{                       // label ONLY on exact 10-minute boundaries
        const d=new Date(v);
        const m= useLocalTZ ? d.getMinutes() : new Date(d.toISOString()).getUTCMinutes();
        if(m % 10 !== 0) return '';
        return useLocalTZ
          ? d.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})
          : d.toISOString().substring(11,16)+' UTC';
      }
    },
    grid:{ color:'rgba(148,163,184,.2)' }
  };
}

/* --------- tooltip titles honor timezone --------- */
function tooltipTitle(ctx){
  const d = new Date(ctx[0].parsed.x);
  return useLocalTZ ? fmtLocal(d) : fmtUTC(d);
}

/* --------- threshold shading + small label on temp chart --------- */
const thresholdFillPlugin = {
  id: 'thresholdFill',
  beforeDraw(chart) {
    const yS = chart.scales.y, area = chart.chartArea;
    if (!yS || !area) return;
    const y = yS.getPixelForValue(HOT_THRESHOLD);
    const ctx = chart.ctx;

    // Shaded region above threshold
    ctx.save();
    ctx.globalAlpha = 0.22;
    ctx.fillStyle = '#ef4444';
    ctx.fillRect(area.left, area.top, area.right - area.left, Math.max(0, y - area.top));
    ctx.restore();

    // Dashed line
    ctx.save();
    ctx.strokeStyle = '#ff6b6b';
    ctx.lineWidth = 1.25;
    ctx.setLineDash([6,4]);
    ctx.beginPath(); ctx.moveTo(area.left, y); ctx.lineTo(area.right, y); ctx.stroke();
    ctx.restore();

    // Tiny annotation text at the right edge
    ctx.save();
    ctx.font = '12px system-ui, -apple-system, Segoe UI, Roboto, Arial';
    ctx.fillStyle = '#ffd7d7';
    ctx.textAlign = 'right';
    ctx.textBaseline = 'bottom';
    ctx.fillText(`${HOT_THRESHOLD} °C`, area.right - 6, y - 4);
    ctx.restore();
  }
};

/* --------- chart factory --------- */
function makeChart(ctx, datasets, plugins=[]) {
  return new Chart(ctx, {
    type:'line',
    data:{ datasets },
    options:{
      parsing:true, animation:false, normalized:true,
      plugins:{
        legend:{display:true, labels:{color:'#e2e8f0'}},
        tooltip:{mode:'index', intersect:false, callbacks:{ title: tooltipTitle }}
      },
      scales:{
        x: xTimeScale(),
        y:{ ticks:{color:'#e2e8f0'}, grid:{color:'rgba(148,163,184,.2)'} }
      }
    },
    plugins
  });
}

/* ---------------- render ---------------- */
function render(j){
  const data = Array.isArray(j.data) ? j.data : [];
  const host = j.host ?? 'raspberrypi';
  document.getElementById('host').textContent = host;

  const last = data.length ? data[data.length-1] : null;

  // Summary
  const curTemp = last ? Number(last.temp_c) : NaN;
  const curEl = document.getElementById('cur');
  curEl.textContent = isFinite(curTemp) ? curTemp.toFixed(1) : '—';
  curEl.className = 'stat ' + (isFinite(curTemp) ? (curTemp>=HOT_THRESHOLD?'hot stat':'ok stat') : 'stat');

  const upd = last ? new Date(last.ts) : null;
  document.getElementById('tz-label').textContent = useLocalTZ ? 'Local' : 'UTC';
  document.getElementById('upd').textContent = upd ? (useLocalTZ ? fmtLocal(upd) : fmtUTC(upd)) : '—';

  // Bridge info
  const uplink = last?.uplink_if ?? '—';
  const defif  = last?.default_if ?? '—';
  const bridge = !!last?.bridge_active;
  document.getElementById('uplinkBadge').textContent  = 'uplink: ' + uplink;
  document.getElementById('defaultBadge').textContent = 'default: ' + defif;

  const bt = document.getElementById('bridgeText');
  bt.textContent = 'BRIDGE: ' + (bridge ? 'ACTIVE' : 'idle');
  bt.className = 'bridgeText ' + (bridge ? 'active' : 'idle');

  // Datasets
  const ptsTemp   = toPoints(data, 'temp_c');
  const ptsCPU    = toPoints(data, 'cpu_percent');
  const ptsRAM    = toPoints(data, 'ram_percent');
  const ptsUpMbps = toPoints(data, 'net_tx_bps').map(p=>({x:p.x, y: mbpsFromBps(p.y)})).filter(p=>p.y!=null);
  const ptsDnMbps = toPoints(data, 'net_rx_bps').map(p=>({x:p.x, y: mbpsFromBps(p.y)})).filter(p=>p.y!=null);

  // Chart: Temperature
  if(!charts.temp){
    charts.temp = makeChart(document.getElementById('chartTemp').getContext('2d'), [
      {label:'Temperature (°C)', data: ptsTemp, borderColor:'#60a5fa', pointRadius:0, tension:.2}
    ], [thresholdFillPlugin]);
    charts.temp.options.scales.y.suggestedMin = 20;
    charts.temp.options.scales.y.suggestedMax = 80;
    charts.temp.update();
  } else {
    charts.temp.data.datasets[0].data = ptsTemp;
    charts.temp.options.scales.x = xTimeScale(); // re-apply axis config (timezone)
    charts.temp.update();
  }

  // Chart: CPU & RAM
  if(!charts.cpu){
    charts.cpu = makeChart(document.getElementById('chartCpuRam').getContext('2d'), [
      {label:'CPU %', data: ptsCPU, borderColor:'#93c5fd', pointRadius:0, tension:.2},
      {label:'RAM %', data: ptsRAM, borderColor:'#a78bfa', pointRadius:0, tension:.2}
    ]);
    charts.cpu.options.scales.y.suggestedMin = 0;
    charts.cpu.options.scales.y.suggestedMax = 100;
    charts.cpu.update();
  } else {
    charts.cpu.data.datasets[0].data = ptsCPU;
    charts.cpu.data.datasets[1].data = ptsRAM;
    charts.cpu.options.scales.x = xTimeScale();
    charts.cpu.update();
  }

  // Chart: Network (Mb/s)
  if(!charts.net){
    charts.net = makeChart(document.getElementById('chartNet').getContext('2d'), [
      {label:'Upload (Mb/s)',   data: ptsUpMbps, borderColor:'#34d399', pointRadius:0, tension:.2},
      {label:'Download (Mb/s)', data: ptsDnMbps, borderColor:'#f472b6', pointRadius:0, tension:.2}
    ]);
    charts.net.update();
  } else {
    charts.net.data.datasets[0].data = ptsUpMbps;
    charts.net.data.datasets[1].data = ptsDnMbps;
    charts.net.options.scales.x = xTimeScale();
    charts.net.update();
  }
}

/* ---------------- boot ---------------- */
async function loadAndRender(){ try{ render(await fetchJsonNoCache(BLOB_URL)); }catch(e){ console.error(e); } }
document.getElementById('tzToggle').addEventListener('change', e=>{ useLocalTZ = !useLocalTZ; loadAndRender(); });
loadAndRender(); setInterval(loadAndRender, 60_000);
</script>
</body>
</html>
